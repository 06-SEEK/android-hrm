language: android
jdk:
- oraclejdk8
env:
  global:
  - ANDROID_API=28
  - OWNER=${TRAVIS_REPO_SLUG%/*}
  - DEV=${OWNER/vanhiep184/dev}
  - BRANCH=${TRAVIS_BRANCH/main/}
  - TAG=${DEV}${BRANCH:+_}${BRANCH}
android:
  components:
  - tools
  - tools
  - platform-tools
  - build-tools-28.0.3
  - android-${ANDROID_API}
  - extra-google-google_play_services
  - extra-google-m2repository
  - extra-android-m2repository
  licenses:
  - android-sdk-license-.+
before_install:
- openssl aes-256-cbc -K $encrypted_59da33dcd24e_key -iv $encrypted_59da33dcd24e_iv
  -in keyhrm.enc -out keyhrm -d
- yes | sdkmanager "platform-tools" "platforms;android-28"
- chmod +x gradlew
script:
- "./gradlew clean build connectedAndroidTest -PdisablePreDex --stacktrace"
# notifications:
#   email: true
# before_cache:
# - rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
# cache:
#   directories:
#   - "$HOME/.m2"
#   - "$HOME/.gradle"
#   - "$HOME/.gradle/caches/"
#   - "$HOME/.gradle/wrapper/"
before_deploy:
- export APP_VERSION=$(./gradlew :app:printVersionName)
 # Set up git user name and tag this commit
- git config --local user.name "YOUR GIT USER NAME"
- git config --local user.email "YOUR GIT USER EMAIL"
- export TRAVIS_TAG=${TRAVIS_TAG:-$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)}
- git tag $TRAVIS_TAG
deploy:
  provider: releases
  api_key: "$GITHUB_TOKEN"
  file: app/build/outputs/apk/release/*
  file_glob: true
  skip_cleanup: true
  overwrite: true
  name: "$APP_VERSION"
  tag_name: "$APP_VERSION"
  on:
    tags: true
    branch: main
# after_success:
# - sh set_tags.sh
